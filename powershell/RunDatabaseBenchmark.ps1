# ----------------------------------------------------------------------
# Continuously picks a random SQL script from the specified directory, 
# execute it against the specified SQL Server database, and then sleep 
# for 100 milliseconds before repeating the process.
# 
# Mostly generated by GPT-4
#
# rudi@babaluga.com, go ahead license
# ----------------------------------------------------------------------


# if needed
# Install-Module -Name SqlServer -Scope CurrentUser

# Import the SQL Server module
Import-Module SqlServer

# Define the SQL Server connection parameters
$serverName = "your_sql_server_instance"
$databaseName = "your_database_name"
$credential = Get-Credential # You will be prompted to enter your SQL Server username and password

# Define the path to the directory containing SQL scripts
$sqlScriptsFolderPath = "path\to\sql\scripts\folder"

# Function to execute a SQL script against the SQL Server database
function Invoke-SqlScript($filePath, $server, $database, $credential) {
    $query = Get-Content -Path $filePath -Raw
    Invoke-Sqlcmd -ServerInstance $server -Database $database -Credential $credential -Query $query
}

# Function to run the benchmark
function Invoke-Benchmark($folderPath, $server, $database, $credential, $sleepInterval) {
    while ($true) {
        $sqlFiles = Get-ChildItem -Path $folderPath -Filter *.sql
        $randomFile = Get-Random -InputObject $sqlFiles
        Write-Host "Executing $($randomFile.Name)"
        Invoke-SqlScript -filePath $randomFile.FullName -server $server -database $database -credential $credential

        Start-Sleep -Milliseconds $sleepInterval
    }
}

# Run the benchmark with the specified parameters
Invoke-Benchmark -folderPath $sqlScriptsFolderPath -server $serverName -database $databaseName -credential $credential -sleepInterval 100
